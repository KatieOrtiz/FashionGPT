<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <title>Favorites</title>
</head>
<body class="single-section-page">
    <header class="header">
      <div class="container">
        <nav class="navbar">
          <h1>FashionGPT</h1>
          <ul>
            <li></li>
            <span id="homebutton"><i class="fas fa-house"></i></span>
            <span id="likebutton"><i class="fas fa-heart"></i></span>
            <span id="settingbutton"><i class="fas fa-gear"></i></span>
          </ul>
        </nav>
      </div>
    </header>
    <div class="container">
    <div id="output-section"></div>
    {% for suggestion_id, products in suggestion_products.items() %}
    {% if suggestion_id in favorite_suggestion_ids %}
    <div class="user-suggestion" id="user-suggestion-{{ suggestion_id }}" style="display: none;">
        <h2>User Suggestion #{{ loop.index }}</h2> 
        <!-- Button to mark suggestion as favorite -->
        <button class="mark-favorite" data-suggestion-id="{{ suggestion_id }}">
          {% if suggestion_id in favorite_suggestion_ids %}
              <i class="fas fa-heart"></i> <!-- Filled heart icon -->
          {% else %}
              <i class="far fa-heart"></i> <!-- Unfilled heart icon -->
          {% endif %}
      </button>
        <div class="suggested-products">
          <br>
            <!-- Display products for this suggestion -->
            {% for product in products %}
            <div class="clothing-item-tile">
                <!-- Display product image -->
                <img class="product-image" src="{{ product.image }}" alt="Product Image" style="max-width: 200px; max-height: 200px;">
                <h3>{{ product.name }}</h3>
                <p>Price: {{ product.price }}</p>
                <!-- Add more details if needed -->
                <a href="{{ product.link }}">View Product</a>
            </div>
            {% endfor %}
        </div> 
       
    </div>
    {% endif %}
    {% endfor %}
    <script src="static/script.js"></script>  
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Check if each user suggestion should be displayed based on favorite_suggestions.txt
        const favoriteSuggestions = {% raw %}{{ favorite_suggestion_ids | tojson | safe }}{% endraw %}; // Convert to JavaScript array
        console.log('Loaded favorite suggestion IDs:', favoriteSuggestions); // Log loaded suggestion IDs
        favoriteSuggestions.forEach(function(suggestionId) {
            const userSuggestion = document.getElementById('user-suggestion-' + suggestionId);
            if (userSuggestion) {
                userSuggestion.style.display = 'block'; // Show the user suggestion
            }
        });

        // Add event listener to all mark favorite buttons
        document.querySelectorAll('.mark-favorite').forEach(function(button) {
            // Check if suggestion is already favorited
            const suggestionId = button.dataset.suggestionId;
            fetch('/check-favorite?suggestion_id=' + suggestionId)
                .then(response => response.json())
                .then(data => {
                    if (data.isFavorite) {
                        button.innerHTML = '<i class="fas fa-heart"></i>'; // Filled heart icon
                    }
                });

            button.addEventListener('click', function() {
                // Get the suggestion ID from data attribute
                const suggestionId = button.dataset.suggestionId;
                
                // Toggle favorite status
                if (button.classList.contains('favorited')) {
                    // Remove from favorites
                    fetch('/remove-favorite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ suggestion_id: suggestionId })
                    })
                    .then(response => {
                        if (response.ok) {
                            button.innerHTML = '<i class="far fa-heart"></i>'; // Unfilled heart icon
                            button.classList.remove('favorited');
                        } else {
                            alert('Failed to remove suggestion from favorites.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to remove suggestion from favorites.');
                    });
                } else {
                    // Add to favorites
                    fetch('/mark-favorite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ suggestion_id: suggestionId })
                    })
                    .then(response => {
                        if (response.ok) {
                            button.innerHTML = '<i class="fas fa-heart"></i>'; // Filled heart icon
                            button.classList.add('favorited');
                        } else {
                            alert('Failed to mark suggestion as favorite.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to mark suggestion as favorite.');
                    });
                }
            });
        });
    });
    </script>
  </body>
</html>
